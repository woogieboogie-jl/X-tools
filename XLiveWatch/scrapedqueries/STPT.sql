WITH foundation_list AS (
  SELECT *
  FROM (VALUES
      ('0x5e2038c0867a717a9b971a3b36f18a9c9d3ca488'), -- Team (Block72 & STP)
      ('0xb794499d1a16b08b09b1aa2213debae870e60120'), -- Community
      ('0xc2c10257efc6ed5e3e8c3a050a698f3b86bd81c7') -- Reserve (Validator Rewards & STP Ecosystem)
    )
  AS foundation(FOUNDATION)
),
  daily_transfers AS (
    SELECT
      DATE(BLOCK_TIMESTAMP) as TIMESTAMP,
      SUM(
        CASE
          WHEN FROM_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN - RAW_AMOUNT/POW(10, 18)
          WHEN TO_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN RAW_AMOUNT/POW(10, 18)
          ELSE 0
        END
      ) AS daily_balance_change
    FROM
      ethereum.core.ez_token_transfers
    WHERE
      CONTRACT_ADDRESS = LOWER('0xDe7D85157d9714EADf595045CC12Ca4A5f3E2aDb')
      AND (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) OR TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      AND NOT (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) AND TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
    GROUP BY TIMESTAMP
)

SELECT
DISTINCT TIMESTAMP AS DATE,
   2000000000 - SUM(daily_balance_change) OVER (
    ORDER BY
      TIMESTAMP
  ) AS CIRCULATING,
  (EXTRACT(EPOCH FROM TIMESTAMP) - 1559692800)/86400 AS DAYS,
  CASE
    WHEN DAYS BETWEEN 0 AND 483 THEN 694041335 + DAYS * 196890
    WHEN DAYS BETWEEN 483 AND 575 THEN 789138995 + DAYS * 1324994
    WHEN DAYS BETWEEN 575 AND 665 THEN 911038413 + DAYS * 1056641
    WHEN DAYS BETWEEN 665 AND 756 THEN 1006136072 + DAYS * 1339554
    WHEN DAYS BETWEEN 756 AND 848 THEN 1128035490 + DAYS * 1033670
    WHEN DAYS BETWEEN 848 AND 940 THEN 1223133149 + DAYS * 1324994
    WHEN DAYS BETWEEN 940 AND 1030 THEN 1345032567 + DAYS * 1056641
    WHEN DAYS BETWEEN 1030 AND 1121 THEN 1440130227 + DAYS * 1339554
    WHEN DAYS BETWEEN 1121 AND 1213 THEN 1562029644 + DAYS * 1033670
    WHEN DAYS BETWEEN 1213 AND 1305 THEN 1657127304 + DAYS * 1033670
    WHEN DAYS BETWEEN 1305 AND 1395 THEN 1752224964 + DAYS * 1056641
    WHEN DAYS BETWEEN 1395 AND 1486 THEN 1847322623 + DAYS * 1045029
    WHEN DAYS > 1486 THEN 1942420283 
  END AS PLANNED
FROM
  daily_transfers
ORDER BY
  TIMESTAMP;
