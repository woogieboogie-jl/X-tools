WITH foundation_list AS (
  SELECT *
  FROM (VALUES
('0x1d7c6783328c145393e84fb47a7f7c548f5ee28d'), -- Deployer
('0x65bb797c2b9830d891d87288f029ed8dacc19705'), -- Contributor, Investor
('0x45a01e4e04f14f7a4a6702c74187c5f6222033cd'), -- Launch Auction
('0x8a27e7e98f62295018611dd681ec47c7d9ff633a')  -- Community
      )
  AS foundation(FOUNDATION)
),
  daily_transfers AS (
    SELECT
      DATE(BLOCK_TIMESTAMP) as TIMESTAMP,
      SUM(
        CASE
          WHEN FROM_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN - RAW_AMOUNT/POW(10, 18)
          WHEN TO_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN RAW_AMOUNT/POW(10, 18)
          ELSE 0
        END
      ) AS daily_balance_change
    FROM
      ethereum.core.ez_token_transfers
    WHERE
      CONTRACT_ADDRESS = LOWER('0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6')
      AND (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) OR TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      AND NOT (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) AND TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
    GROUP BY TIMESTAMP
)

SELECT
  DISTINCT TIMESTAMP AS DATE,
  1000000000 - SUM(daily_balance_change) OVER (
    ORDER BY
      TIMESTAMP
  ) AS CIRCULATING,
  (EXTRACT(EPOCH FROM TIMESTAMP) - 1647475200 )/86400 AS DAYS,
  CASE
    WHEN DAYS < 0 THEN  528900000
    WHEN DAYS BETWEEN 0 AND 92 THEN 528900000 + DAYS * 229347.83
    WHEN DAYS BETWEEN 92 AND 365 THEN 550000000 + (DAYS-92) * 0
    WHEN DAYS BETWEEN 365 AND 549 THEN 550000000 + (DAYS-365) * 1019021.74
    WHEN DAYS BETWEEN 549 AND 1096 THEN 737500000 + (DAYS-549) * 479890.31
    WHEN DAYS > 1096 THEN 1000000000
  END AS PLANNED
FROM
  daily_transfers
ORDER BY
  TIMESTAMP;
 


