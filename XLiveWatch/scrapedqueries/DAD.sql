WITH foundation_list AS (
  SELECT *
  FROM (VALUES
-- Public sale managed by coinlist
('0x36f405d5f2a228b755cfb5191fcb0eba1b55f497'),
('0xd21e14023e8d247e2ac4c7adfc1d25441e492278'),
('0x752b354a393949fbd4291d2000dabe338913802f'),
('0x8fd67ae5aef1fbfdc4a413b7cda8d46ce6092026'),
('0x387cf0506614713f7d36afaca5be680c6ab80be1'),
('0xb84c018d9c867a7d8ad422b1caf64a9367366b24'),
('0xff1c984ab6a390d4b5cd8b51efc2476f129e6e69'),
('0x9afece3bcac0cb1c632df0f7fa4f9c4d808758c9'),
('0xd88db3374389f226337cd55af0574762fed5b3ef'),
('0x31bc7c9f05f18621c3a53d93100afb65fa669602'),
('0xfe03932ded338dabb5626455be60543a4f2c3797'),
('0xaf656a53d71223765ef380272c1044df43ad6838'),
('0xb0cdfdd151eb4066ef7f47a93f6739e44534f785'),
-- Ceffu custody
('0x36f405d5f2a228b755cfb5191fcb0eba1b55f497'),
('0x07c7ee9c065ff2bee1b3f433da2704a28414e57a'), -- optimism
-- Vesting
('0xc0af6b8f188ade028a552ba7d778e896845922c9'),
('0xb2bbfc07948fedeb5935316203c33ce70bef57d0'),
('0xdb67d7738871e4e888848e307b9f666fb526f794'),
('0xcc30bb544864137c213cd6629b7eb3a03af3b2c9'),
-- Community tresury
('0x360227bf3f27cdd493d6f90b20c1a4cb8f4e1898')
      )
  AS foundation(FOUNDATION)
),
  daily_transfers AS (
    SELECT
      DATE(BLOCK_TIMESTAMP) as TIMESTAMP,
      SUM(
        CASE
          WHEN FROM_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN - RAW_AMOUNT/POW(10, 18)
          WHEN TO_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN RAW_AMOUNT/POW(10, 18)
          ELSE 0
        END
      ) AS daily_balance_change
    FROM
      ethereum.core.ez_token_transfers
    WHERE
      CONTRACT_ADDRESS = LOWER('0x14778860E937f509e651192a90589dE711Fb88a9')
      AND (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) OR TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      AND NOT (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) AND TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
    GROUP BY TIMESTAMP
  UNION ALL
    SELECT
      DATE(BLOCK_TIMESTAMP) as TIMESTAMP,
      SUM(
        CASE
          WHEN FROM_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN - RAW_AMOUNT/POW(10, 18)
          WHEN TO_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN RAW_AMOUNT/POW(10, 18)
          ELSE 0
        END
      ) AS daily_balance_change
    FROM
      optimism.core.ez_token_transfers
    WHERE
      CONTRACT_ADDRESS = LOWER('0x14778860E937f509e651192a90589dE711Fb88a9')
      AND (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) OR TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      AND NOT (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) AND TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
    GROUP BY TIMESTAMP
  )

SELECT
  DISTINCT TIMESTAMP AS DATE,
   100000000 - SUM(daily_balance_change) OVER (
    ORDER BY
      TIMESTAMP
  ) AS CIRCULATING,
  (EXTRACT(EPOCH FROM TIMESTAMP) - 1690848000 )/86400 AS DAYS,
  CASE
    WHEN DAYS < 0 THEN 11038000
    WHEN DAYS BETWEEN 0 AND 184 THEN 11038000 + DAYS * 47357.80988
    WHEN DAYS BETWEEN 184 AND 366 THEN 19751837.02 + (DAYS-184) * 35129.54901
    WHEN DAYS BETWEEN 366 AND 458 THEN 26145414.94 + (DAYS-366) * 58070.18828
    WHEN DAYS BETWEEN 458 AND 1096 THEN 31487872.26 + (DAYS-458) * 71768.81841
    WHEN DAYS BETWEEN 1096 AND 1461 THEN 77276378.4 + (DAYS-1096) * 53429.40235
    WHEN DAYS BETWEEN 1461 AND 1553 THEN 96778110.26 + (DAYS-1461) * 19058.23605
    WHEN DAYS BETWEEN 1553 AND 1827 THEN 98531467.98 + (DAYS-1553) * 5359.605911
    WHEN DAYS > 1827 THEN 100000000
  END AS PLANNED
FROM
  daily_transfers
ORDER BY
  TIMESTAMP
