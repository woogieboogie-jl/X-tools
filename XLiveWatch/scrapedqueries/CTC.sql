WITH foundation_list AS (
  SELECT *
  FROM (VALUES
('0x0830d841fe040df31db5fadfc436a890fe8aa57a'),
('0x0a3a9d650fbea5a714864997872118d00cd8e101'),
('0x14c2f1b93afd0a0482f7ea93a28b802e91759a1b'),
('0x155af9b117add75a4391c9c1fb35f16f682bda85'),
('0x16d43e797d14d626a90060ac7cf9b451f77ec1e8'),
('0x1895fe90eca7d998bd9299ac4ed768c89509f12d'),
('0x1ef5ee20b208c1c3df803f979a052be9da6ecc9a'),
('0x1fbeac51f3342ca869b2042e283c8164ff3769de'),
('0x2091b2f1616881942050a20df15b2cb609e3ef68'),
('0x2676aec74dc54b13c0ec700fa1ee81b80e348f1d'),
('0x2708ae0e25410460334251378938ef1d670dc236'),
('0x2c21b180014b5fb261a2253962a2ca9ebd33bf8e'),
('0x30056b0ca749c32a9a0bda26c3e6dc63188eda53'),
('0x31531dfd1dd1e27e27e2413b834d9f6b4c0ecda1'),
('0x320820c0521acda6cff8932c20db262db6e1d331'),
('0x394edb04f4269e5be444d798276a871e11c2b05f'),
('0x44b7223103773dec3a79701ef0b7ad4f1a1851f8'),
('0x465c30ffcaf1da2f7d4af9d16903c335726ad575'),
('0x4b0125ceb458492ecb4ab392cafc4db803d52f45'),
('0x5631347d8e87e36622c1886ea68d4aa990320b3f'),
('0x56d8b4028c1b5f36ff226cfd0e9a45d7b024412c'),
('0x6cb46dae02aab63f823fd52974fd879f7d96c164'),
('0x6facd83f31af2493a8663368ff764d29b6f0c810'),
('0x79ad0af3092f1fdc5ae9bd41bc59b1c09f0fc55e'),
('0x7af3243dd4d47cbf63d5f9e4811a4cffd9fff9a7'),
('0x7bd20756c1bfbf32e47b267be09ecc4e3ed83aa4'),
('0x84ac77083a2a797c8c75dfc41251e8f15e77b248'),
('0x8583db2118d5778b0fbcdd0402d624dc057e85f4'),
('0x9fb839a489a147b4b54cbcb2b7fcdb46cfc73b73'),
('0xa2470765fd58b6aab3d5fdd4473e926c541a06a7'),
('0xab991c1dbb2863cfa602698f613713b00d03dd39'),
('0xb11b39767c9afdd1b30cae0cc519451b15342e3c'),
('0xb2f3ed5394a0daf7b963dd96fd0ac308fc5f2601'),
('0xbcee49719880081028ea4e77fd66fa9a0d09dcfa'),
('0xc26b216d0ac3595d3adbb71b7dd16d7853725f2d'),
('0xc703e6c1a7e58c65748b441174ae17bca29ad408'),
('0xc7ad7f05cca6cca522662e1eb08b3ad3271872ff'),
('0xca824f3e99de9f620f1fea877f4a152673d03b00'),
('0xd1156a487673ba8a1ad06e6635d91db34864f0ab'),
('0xd283234f67d2ff252d15b843b8407e421e011572'),
('0xd3f881773e7a5c5766deaf0647ca3e6c033b8557'),
('0xd4ac4fc79aeb7d7162b01d920a603418142b45e2'),
('0xdaa89fc0a9b1c0f4ae02bdf7958846c4bbaba238'),
('0xe16f669a141c36eb4431abe587e8b003ab1c1cd4'),
('0xe2a5ec4ea2c7dc8a06af331e14de2072b7518f16'),
('0xe6b45393b3de91cc5f062b9774c3d9e87222aace'),
('0xe7e074aa19f27af70883d95fd6493572895fb6da'),
('0xfbad2a78285ecac5613e40fe60c2789607016709'),
('0xff4431bc618f8405f21fa42f7d420ad9090b6faa')
      )
  AS foundation(FOUNDATION)
),
  daily_transfers AS (
    SELECT
      DATE(BLOCK_TIMESTAMP) as TIMESTAMP,
      SUM(
        CASE
          WHEN FROM_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN - RAW_AMOUNT/POW(10, 18)
          WHEN TO_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN + RAW_AMOUNT/POW(10, 18)
          ELSE 0
        END
      ) AS daily_balance_change
    FROM
      ethereum.core.ez_token_transfers
    WHERE
      CONTRACT_ADDRESS = LOWER('0xa3ee21c306a700e682abcdfe9baa6a08f3820419')
      AND     (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) OR TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      AND NOT (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) AND TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      AND TX_HASH != '0x31ed20cd8f275163341a676d284cdbfaf608cf4cd15441bfce2e38b23cfbc44e'
    GROUP BY
      TIMESTAMP
  )
SELECT
  TIMESTAMP AS DATE,
  (EXTRACT(EPOCH FROM TIMESTAMP) - 1555891200)/86400 AS DAYS,
  CASE
    WHEN DAYS BETWEEN 0 AND 183 THEN 0 + DAYS * 917189.49
    WHEN DAYS BETWEEN 183 AND 365 THEN 167845676.02 + (DAYS-183) * 271043.87
    WHEN DAYS BETWEEN 365 AND 730 THEN 217175660.17 + (DAYS-365) * 253882.82
    WHEN DAYS BETWEEN 730 AND 1095 THEN 309842888.33 + (DAYS-730) * 247005.79
    WHEN DAYS BETWEEN 1095 AND 2190 THEN  400000000 + (DAYS-1095) * 182648.40
    WHEN DAYS > 2190 THEN  600000000
  END AS PLANNED,
  PLANNED - DAYS * 182648.40 - SUM(daily_balance_change) OVER ( ORDER BY TIMESTAMP  )
   AS CIRCULATING
FROM
  daily_transfers
ORDER BY
  TIMESTAMP;



