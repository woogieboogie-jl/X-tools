WITH foundation_list AS (
  SELECT *
  FROM (VALUES
        ('0xd2c7e55f048770999679e266cb99e57c97b0bcf9'), -- Deployer
        ('0xe1d1ad55254b29b43035937894514d0adbac7aea'), -- IMX Holdings
        ('0x971f723194796dbf04dcfe361ed584cae9bf94a0'), -- Foundation Treasury: Unlocked
        ('0x237343c10705ae7605850977503e25a8c12851e6'), -- Foundation Treasury: Locked
        ('0x9ccc2cfc1da5c2623b9ad74dcf01765eae273539'), -- Project Development 1
        ('0x14650700fec5697c014e8332169f93734a6c5741'), -- Project Development 2
        ('0x177f9dd13ccc02065c7494ea8396e4e2ba54dfa1') -- For adjustment
        --('0x5fdcca53617f4d2b9134b29090c87d01058e27e9'), -- Bridge
      )
  AS foundation(FOUNDATION)
),
  daily_transfers AS (
    SELECT
      DATE(BLOCK_TIMESTAMP) as TIMESTAMP,
      SUM(
        CASE
          WHEN FROM_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN - RAW_AMOUNT/POW(10, 18)
          WHEN TO_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN RAW_AMOUNT/POW(10, 18)
          ELSE 0
        END
      ) AS daily_balance_change
    FROM
      ethereum.core.ez_token_transfers
    WHERE
      CONTRACT_ADDRESS = LOWER('0xf57e7e7c23978c3caec3c3548e3d615c346e79ff')
      AND (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) OR TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      AND NOT (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) AND TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
    GROUP BY TIMESTAMP
)

SELECT
  DISTINCT TIMESTAMP AS DATE,
  2000000000 - SUM(daily_balance_change) OVER (
    ORDER BY
      TIMESTAMP
  ) AS CIRCULATING,
  (EXTRACT(EPOCH FROM TIMESTAMP) - 1636070400)/86400 AS DAYS,
  CASE
    WHEN DAYS BETWEEN 0 AND 181 THEN 319417600 + DAYS * 2834598.895
    WHEN DAYS BETWEEN 181 AND 365 THEN 832480000 + (DAYS-181) * 562173.913
    WHEN DAYS BETWEEN 365 AND 546 THEN 935920000 + (DAYS-365) * 2526298.343
    WHEN DAYS BETWEEN 546 AND 730 THEN 1393180000 + (DAYS-546) * 1203152.174
    WHEN DAYS BETWEEN 730 AND 911 THEN  1614560000 + (DAYS-730) * 651602.2099
    WHEN DAYS BETWEEN 911 AND 1095 THEN  1732500000 + (DAYS-911) * 339673.913
    WHEN DAYS BETWEEN 1095 AND 1276 THEN  1795000000 + (DAYS-1095) * 345303.867
    WHEN DAYS BETWEEN 1276 AND 1460 THEN  1857500000 + (DAYS-1276) * 339673.913
    WHEN DAYS > 1460 THEN  2000000000
  END AS PLANNED
FROM
  daily_transfers
ORDER BY
  TIMESTAMP;
