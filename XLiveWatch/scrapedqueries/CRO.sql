WITH foundation_list AS (
  SELECT *
  FROM (VALUES
('0xfddac11e0072e3377775345d58de0dc88a964837'), -- Deployer
('0xcc477b21d471fb9394a56aace72c8d59ac80f6af'), -- Multisig
-- Foundation
('0x3dd509eea1cbe2fe00fbbce496dd453bfde74e7f'),
('0x45a2eb4d96a84a1b408e98f04a3908776f2a41b4'),
('0x8a8cae62949f5b28a7ae0f47c802f33fc8f68702')
      )
  AS foundation(FOUNDATION)
),
  daily_transfers AS (
    SELECT
      DATE(BLOCK_TIMESTAMP) as TIMESTAMP,
      SUM(
        CASE
          WHEN FROM_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN - RAW_AMOUNT/POW(10, 18)
          WHEN TO_ADDRESS IN (SELECT FOUNDATION FROM foundation_list) THEN RAW_AMOUNT/POW(10, 18)
          ELSE 0
        END
      ) AS daily_balance_change
    FROM
      ethereum.core.ez_token_transfers
    WHERE
      CONTRACT_ADDRESS = LOWER('0x3506424f91fd33084466f402d5d97f05f8e3b4af')
      AND     (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) OR TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      AND NOT (FROM_ADDRESS in (SELECT FOUNDATION FROM foundation_list) AND TO_ADDRESS in (SELECT FOUNDATION FROM foundation_list))
      
    GROUP BY
      TIMESTAMP
  )
SELECT
  TIMESTAMP AS DATE,
  8888888888 - SUM(daily_balance_change) OVER (
    ORDER BY TIMESTAMP
  ) AS CIRCULATING,
  (EXTRACT(EPOCH FROM TIMESTAMP) - 1640908800)/86400 AS DAYS,
  CASE
    WHEN DAYS < 0 THEN 7373219376
    WHEN DAYS BETWEEN 0 AND 31 THEN 7373219376 + DAYS * 11426645.84
    WHEN DAYS BETWEEN 31 AND 181 THEN 7727445397 + (DAYS-31) * 411522.6333
    WHEN DAYS BETWEEN 181 AND 212 THEN 7789173792 + (DAYS-181) * 11426645.84
    WHEN DAYS BETWEEN 212 AND 365 THEN 8143399813 + (DAYS-212) * 403453.5621
    WHEN DAYS BETWEEN 365 AND 396 THEN 8205128208 + (DAYS-365) * 11028398.13
    WHEN DAYS BETWEEN 396 AND 546 THEN 8547008550
    WHEN DAYS BETWEEN 546 AND 577 THEN 8547008550 + (DAYS-546) * 11028398.13
    WHEN DAYS > 577 THEN 8888888892
  END AS PLANNED
FROM
  daily_transfers
ORDER BY
  TIMESTAMP;
